<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Sampler</title>
    <style>
        body { font-family: monospace; background: #222; color: #eee; padding: 20px; }
        #console { 
            background: #000; border: 1px solid #444; 
            height: 300px; overflow-y: scroll; padding: 10px; 
            white-space: pre-wrap; margin-top: 20px; font-size: 14px; color: #0f0;
        }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; background: #444; color: #fff; border: 1px solid #666; }
        button:hover { background: #555; }
        button:disabled { background: #333; color: #888; cursor: not-allowed; }
        .controls { display: flex; gap: 20px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;}
        h1 { margin-top: 0; width: 100%; }
        .instructions { background: #333; padding: 15px; border-radius: 5px; margin-bottom: 20px; line-height: 1.5; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;}
        #status { font-weight: bold; color: #ffaa00; }
        
        .mic-indicator {
            width: 15px; height: 15px; border-radius: 50%;
            background-color: #333; border: 1px solid #555;
            display: inline-block; margin-left: 10px;
            transition: background-color 0.1s;
        }
        .mic-active { background-color: #0f0; box-shadow: 0 0 10px #0f0; }
        
        #fileMapping { margin-top: 10px; font-size: 0.9em; color: #aaa; }
        .map-item { display: inline-block; margin-right: 15px; background: #2a2a2a; padding: 4px 8px; border-radius: 4px; margin-bottom: 5px; border: 1px solid #444; }
        .key-badge { color: #fff; font-weight: bold; color: #ffaa00; margin-right: 5px; }
    </style>
</head>
<body>

    <div class="controls">
        <h1>Live Sampler (Web Version)</h1>
        <div>
            <button id="startBtn">1. Start Mic & Engine</button>
            <span style="margin-left: 15px;">Mic: <div id="micLed" class="mic-indicator"></div></span>
        </div>
        <div style="margin-left: 20px; border-left: 1px solid #555; padding-left: 20px;">
            <input type="file" id="fileInput" multiple accept="audio/*" style="display:none">
            <button id="uploadBtn" disabled>2. Upload Samples</button>
            <div id="fileMapping">Upload files to map them to keys [Q, W, E, A, S, D]</div>
        </div>
        <div id="status" style="width: 100%; margin-top: 10px;">Status: Waiting to start...</div>
    </div>

    <div class="instructions">
        <div>
            <strong>PERFORMANCE:</strong><br>
            [1-0] : Play / Queue / Select Source<br>
            [R]   : Record Mic (Press to Arm, Speak to Start)<br>
            [L]   : Toggle LOOP on/off<br>
            [M]   : Toggle METRONOME<br>
            [Space]: PANIC (Stop All)<br>
            [- / =]: Select Previous/Next Slot<br>
            [ [ / ] ]: Volume Down / Up<br>
        </div>
        <div>
            <strong>EDITING & FX:</strong><br>
            [Q,W,E,A,S,D] : Load Mapped File to Current Slot<br>
            [Z] : Reverb (Destructive Bounce)<br>
            [X] : Reverse (Destructive Bounce)<br>
            [C] : Pitch Up (Destructive Bounce)<br>
            [V] : Pitch Down (Destructive Bounce)<br>
            [F] : Concatenate Mode<br>
            [G] : Mix Mode
        </div>
    </div>

    <div id="console">--- CHUCK CONSOLE OUTPUT ---<br></div>

    <script type="module">
        import { Chuck } from 'https://cdn.jsdelivr.net/npm/webchuck/+esm';

        // =========================================================
        // JAVASCRIPT LOGIC
        // =========================================================
        const startBtn = document.getElementById('startBtn');
        const uploadBtn = document.getElementById('uploadBtn');
        const fileInput = document.getElementById('fileInput');
        const statusDiv = document.getElementById('status');
        const consoleDiv = document.getElementById('console');
        const micLed = document.getElementById('micLed');
        const fileMappingDiv = document.getElementById('fileMapping');

        let theChuck; 
        let audioContext; // For decoding files
        let fileBuffers = {}; // Stores decoded PCM data: { 81: Float32Array, ... }
        let fileNames = {};   // Stores filenames: { 81: "kick.wav", ... }

        var print = function(msg) {
            consoleDiv.innerText += msg + "\n";
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        };

        function updateMicLed() {
            if(!theChuck) return;
            theChuck.getFloat("micLevel").then((level) => {
                if (level > 0.005) micLed.classList.add("mic-active");
                else micLed.classList.remove("mic-active");
                requestAnimationFrame(updateMicLed);
            }).catch(() => {});
        }

        // 1. START ENGINE
        startBtn.addEventListener('click', async () => {
            try {
                statusDiv.innerText = "Status: Requesting Microphone...";
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                statusDiv.innerText = "Status: Initializing WebChucK...";
                theChuck = await Chuck.init([]); 
                
                // Get Audio Context
                audioContext = new AudioContext();
                const chuckCtx = theChuck.context;
                const micSource = chuckCtx.createMediaStreamSource(stream);
                micSource.connect(theChuck);

                theChuck.chuckPrint = print;

                // NEW: Fetch code from file instead of variable
                statusDiv.innerText = "Status: Fetching main.ck...";
                const response = await fetch('./main.ck');
                if (!response.ok) throw new Error("Could not fetch main.ck");
                const chuckCode = await response.text();

                await theChuck.runCode(chuckCode);
                
                statusDiv.innerText = "Status: RUNNING";
                statusDiv.style.color = "#0f0";
                startBtn.disabled = true;
                uploadBtn.disabled = false;

                updateMicLed();
                setupKeyboard();

            } catch (e) {
                console.error(e);
                statusDiv.innerText = "Error: " + e.message;
                statusDiv.style.color = "#f00";
            }
        });

        // 2. FILE UPLOAD & DECODE (The Robust Fix)
        uploadBtn.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);
            const keys = [81, 87, 69, 65, 83, 68]; // Q, W, E, A, S, D
            const keyNames = ['Q', 'W', 'E', 'A', 'S', 'D'];
            
            fileMappingDiv.innerHTML = "";

            for(let i=0; i<files.length; i++) {
                if(i >= keys.length) break;
                
                const file = files[i];
                const key = keys[i];
                
                print(`[JS] Decoding ${file.name}...`);

                try {
                    // A. Read raw file
                    const arrayBuffer = await file.arrayBuffer();
                    
                    // B. Decode using Browser Native Decoder (Supports everything)
                    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    
                    // C. Mix to Mono (Simple average)
                    const channels = audioBuffer.numberOfChannels;
                    const len = audioBuffer.length;
                    const pcm = new Float32Array(len);
                    
                    const chan0 = audioBuffer.getChannelData(0);
                    if (channels > 1) {
                        const chan1 = audioBuffer.getChannelData(1);
                        for(let s=0; s<len; s++) {
                            pcm[s] = (chan0[s] + chan1[s]) * 0.5;
                        }
                    } else {
                        pcm.set(chan0);
                    }

                    // D. Store in JS memory
                    fileBuffers[key] = pcm;
                    fileNames[key] = file.name;

                    // E. Update UI
                    const tag = document.createElement("span");
                    tag.className = "map-item";
                    tag.innerHTML = `<span class="key-badge">[${keyNames[i]}]</span> ${file.name}`;
                    fileMappingDiv.appendChild(tag);
                    
                    print(`[JS] Ready: ${file.name} mapped to [${keyNames[i]}]`);
                } catch(err) {
                    print(`[JS] Error decoding ${file.name}: ${err.message}`);
                }
            }
        });

        // 3. KEYBOARD HANDLING
        function setupKeyboard() {
            window.addEventListener('keydown', (e) => {
                if (e.repeat) return; 
                let code = e.keyCode; 

                // Is this a mapped file key?
                if (fileBuffers[code]) {
                    const pcmData = fileBuffers[code];
                    print(`[JS] Transferring ${fileNames[code]} to ChucK...`);
                    
                    // A. Send Raw Data to ChucK Global Array
                    theChuck.setFloatArray("loadBuffer", pcmData);
                    
                    // B. Tell ChucK how many samples
                    theChuck.setInt("loadBufferSize", pcmData.length);
                    
                    // C. Trigger the load
                    theChuck.broadcastEvent("loadBufferTrigger");
                } else {
                    // Standard Control Key
                    theChuck.setInt("webKey", code);
                    theChuck.broadcastEvent("webKeyEvent");
                }
            });
        }

    </script>
</body>
</html>